<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.firzzle.llm.mapper.ExamMapper">

    <!-- 문제 목록 조회 -->
    <select id="selectAllExamQuestionsByContentSeq"
            resultType="com.firzzle.llm.dto.ExamDTO"
            parameterType="long">
        SELECT
            exam_seq,
            content_seq,
            question_content,
            model_answer
        FROM fb_ai_exams
        WHERE content_seq = #{contentSeq}
        ORDER BY exam_seq ASC
    </select>

    <!-- 문제 등록 -->
    <insert id="insertExamQuestion" parameterType="com.firzzle.llm.dto.ExamQuestionRequestDTO">
        INSERT INTO fb_ai_exams (
            content_seq, question_content, model_answer
        ) VALUES (
            #{contentSeq}, #{questionContent}, #{modelAnswer}
        )
    </insert>

    <!-- 답변 등록 -->
    <insert id="insertExamAnswer" parameterType="com.firzzle.llm.dto.ExamAnswerDTO">
        INSERT INTO fb_ai_exams_answer (
            exam_seq, user_seq, answer_content, explanation_content, indate
        ) VALUES (
            #{examSeq}, #{userSeq}, #{answerContent}, #{explanationContent}, #{indate}
        )
    </insert>

    <!-- 답변 조회 (페이지네이션, 텍스트 정렬용) -->
    <select id="selectExamAnswerTextsByContentAndUser"
            resultType="com.firzzle.llm.dto.ExamTextDTO"
            parameterType="map">
        SELECT
            e.exam_seq,
            e.question_content AS chat_text,
            'question' AS type,
            a.indate
        FROM fb_ai_exams_answer a
        JOIN fb_ai_exams e ON a.exam_seq = e.exam_seq
        WHERE e.content_seq = #{contentSeq} AND a.user_seq = #{userSeq}

        UNION ALL

        SELECT
            a.exam_seq,
            a.answer_content AS chat_text,
            'answer' AS type,
            a.indate
        FROM fb_ai_exams_answer a
        JOIN fb_ai_exams e ON a.exam_seq = e.exam_seq
        WHERE e.content_seq = #{contentSeq} AND a.user_seq = #{userSeq}

        UNION ALL

        SELECT
            a.exam_seq,
            a.explanation_content AS chat_text,
            'explanation' AS type,
            a.indate
        FROM fb_ai_exams_answer a
        JOIN fb_ai_exams e ON a.exam_seq = e.exam_seq
        WHERE e.content_seq = #{contentSeq} AND a.user_seq = #{userSeq}

        <if test="lastIndate != null">
            AND a.indate &lt; #{lastIndate}
        </if>

        ORDER BY indate DESC
        LIMIT #{limit}
    </select>

    <!-- 아직 응답하지 않은 문제 중 랜덤 1개 -->
    <select id="selectRandomUnansweredExam"
            resultType="com.firzzle.llm.dto.ExamQuestionResponseDTO"
            parameterType="map">
        SELECT e.exam_seq, e.content_seq, e.question_content, e.model_answer, e.start_time, e.reference_text
        FROM fb_ai_exams e
        WHERE e.content_seq = #{contentSeq}
          AND NOT EXISTS (
              SELECT 1 FROM fb_ai_exams_answer a
              WHERE a.exam_seq = e.exam_seq AND a.user_seq = #{userSeq}
          )
        ORDER BY RAND()
        LIMIT 1
    </select>

</mapper>
